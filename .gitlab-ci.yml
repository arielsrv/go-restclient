image: docker.io/golang:1.24.4

default:
  tags:
    - kubernetes-executor

variables:
  GOMODCACHE: $CI_PROJECT_DIR/.gomodcache
  GOLANGCI_LINT_CACHE: $CI_PROJECT_DIR/golangci-lint/.cache
  GOTESTSUM_CACHE: $CI_PROJECT_DIR/gotestsum/.cache
  CGO_ENABLED: 0
  GOEXPERIMENT: nocoverageredesign
  GORACE: "halt_on_error=1"
  GOTESTSUM_FORMAT: "testname"
  GOLANGCI_LINT_TIMEOUT: "5m"

.go-cache:
  before_script:
    - if [ -d "$HOME" ]; then echo "machine gitlab.com login glpat password $CICD_TOKEN" > "$HOME/.netrc"; fi
    - mkdir -p ${GOMODCACHE} ${GOLANGCI_LINT_CACHE} ${GOTESTSUM_CACHE}
    - echo "ğŸ”§ Setting up optimized environment..."
    - go version
    - echo "ğŸ“¦ Cache directories created"
  cache:
    key:
      files:
        - go.mod
        - go.sum
    paths:
      - ${GOMODCACHE}/
      - ${GOLANGCI_LINT_CACHE}/
      - ${GOTESTSUM_CACHE}/
    policy: pull-push

stages:
  - package

build:
  extends: .go-cache
  stage: package
  script:
    # ğŸ“¦ Optimized dependency management
    - echo "ğŸ“¦ Downloading dependencies..."
    - go mod download -x
    - go mod verify
    - echo "âœ… Dependencies ready"

    # ğŸ”¨ Optimized build with stripped binaries
    - echo "ğŸ”¨ Building optimized binaries..."
    - go build -v -ldflags="-s -w -X main.version=$CI_COMMIT_SHA" ./...
    - echo "âœ… Build completed"

    # ğŸ§ª Optimized tests with race detection and coverage
    - echo "ğŸ§ª Running comprehensive tests..."
    - CGO_ENABLED=1 go test -race -v -timeout=10m -coverprofile=coverage.out -covermode=atomic ./...
    - echo "âœ… Tests completed"

    # ğŸ“Š Optimized coverage reports
    - echo "ğŸ“Š Generating coverage reports..."
    - go tool cover -func=coverage.out | tee coverage-func.txt
    - go tool cover -html=coverage.out -o coverage-report.html
    - go tool gocover-cobertura <coverage.out >coverage.xml
    - echo "âœ… Coverage reports generated"

    # ğŸ“‹ Optimized test reports
    - echo "ğŸ“‹ Generating test reports..."
    - go tool gotestsum --junitfile report.xml --format testname
    - echo "âœ… Test reports generated"

    # ğŸ” Optimized linting
    - echo "ğŸ” Running code quality checks..."
    - go tool golangci-lint run --timeout=${GOLANGCI_LINT_TIMEOUT} || true
    - echo "âœ… Code quality checks completed"
    - echo "âœ… All checks completed successfully"

  artifacts:
    when: always
    reports:
      junit: report.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
      codequality: gl-code-quality-report.json
    paths:
      - coverage-report.html
      - coverage-func.txt
      - gl-code-quality-report.json
      - report.xml
      - coverage.xml
    expire_in: 1 week
  coverage: "/\\(statements\\)\\s+\\d+.?\\d+%/"
  allow_failure: false
  only:
    - main
    - merge_request
